<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <title>DatoCMS Excel Importer</title>
  <style>
    body {
      font-family: sans-serif;
      padding: 1rem;
      box-sizing: border-box;
    }
    #log {
      background: #f7f7f7;
      padding: 0.5rem;
      border: 1px solid #ddd;
      height: 200px;
      overflow-y: auto;
      white-space: pre-wrap;
    }
    button {
      margin-top: 0.5rem;
      padding: 0.5rem 1rem;
      cursor: pointer;
    }
  </style>
</head>
<body>
  <h3>Upload Excel File</h3>
  <input type="file" id="fileInput" accept=".xlsx, .xls">
  <button id="importBtn">Import to Dato</button>
  <pre id="log"></pre>

  <!-- XLSX browser build -->
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

  <!-- DatoCMS Plugin SDK -->
  <script type="module">
    import { connect, startAutoResizer } from 'https://cdn.skypack.dev/datocms-plugin-sdk';

    let ctx;

    connect({
      // This tells Dato this plugin offers a Sidebar panel
      manualFieldExtensions() {
        return []; // not a field editor
      },
      manualSidebarExtensions() {
        return [
          {
            id: 'excel-importer',
            label: 'Excel Importer',
            icon: 'file-spreadsheet'
          }
        ];
      },
      async onBoot(pluginCtx) {
        ctx = pluginCtx;
        startAutoResizer(); // auto-fit iframe height
        log('Excel Importer ready in DatoCMS.');
      }
    });

    function log(message) {
      const logEl = document.getElementById('log');
      logEl.textContent += message + '\n';
      logEl.scrollTop = logEl.scrollHeight;
    }

    document.getElementById('importBtn').addEventListener('click', async () => {
      const file = document.getElementById('fileInput').files[0];
      if (!file) {
        log('No file selected.');
        return;
      }

      log(`Reading file: ${file.name} ...`);
      const rows = await parseExcel(file);
      log(`Parsed ${rows.length} rows from Excel.`);

      // Get the current model's itemTypeId from context
      const itemTypeId = ctx.itemType.id;

      for (const row of rows) {
        try {
          const created = await ctx.loaders.items.create({
            itemType: itemTypeId,
            // Map Excel columns to your Dato fields here:
            field1: row['Column A'],
            field2: row['Column B']
          });
          log(`Created item ID: ${created.id}`);
        } catch (error) {
          log(`Error creating item: ${error.message}`);
        }
      }

      log('Import complete.');
    });

    function parseExcel(file) {
      return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onload = (e) => {
          const wb = XLSX.read(e.target.result, { type: 'binary' });
          const ws = wb.Sheets[wb.SheetNames[0]];
          resolve(XLSX.utils.sheet_to_json(ws));
        };
        reader.onerror = reject;
        reader.readAsBinaryString(file);
      });
    }
  </script>
</body>
</html>
