<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <title>DatoCMS Excel Importer</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    body { font-family: sans-serif; padding: 1rem; }
    h3 { margin: 0 0 0.5rem; }
    .row { display: flex; gap: 8px; margin-bottom: 0.5rem; flex-wrap: wrap; }
    input, select, button { padding: 6px; }
    #log { border: 1px solid #ccc; background: #fafafa; padding: 8px; height: 200px; overflow: auto; white-space: pre-wrap; }
  </style>
</head>
<body>
  <h3>Excel → DatoCMS Import</h3>
  <div class="row">
    <input type="file" id="fileInput" accept=".xlsx,.xls,.csv" />
    <button id="previewBtn">Preview</button>
    <button id="importBtn" disabled>Import</button>
  </div>
  <div class="row">
    <label>Target model:</label>
    <select id="itemTypeSelect"></select>
  </div>
  <pre id="log"></pre>

  <!-- XLSX browser build -->
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

  <!-- DatoCMS Plugin SDK browser build -->
  <script src="https://unpkg.com/datocms-plugin-sdk/dist/datocms-plugin-sdk.js"></script>

  <script>
    // Grab SDK functions from global
    const { connect, autoResizer } = window.DatoCmsPlugin;

    let ctx;
    let parsedRows = [];

    function log(msg) {
      const logEl = document.getElementById('log');
      logEl.textContent += msg + '\n';
      logEl.scrollTop = logEl.scrollHeight;
    }

    connect({
      manualFieldExtensions() {
        return [];
      },
      manualSidebarExtensions() {
        return [{ id: 'excel-importer', label: 'Excel Importer', icon: 'file-spreadsheet' }];
      },
      async onBoot(pluginCtx) {
        ctx = pluginCtx;
        autoResizer.startAutoResizer();
        log('Connected to DatoCMS.');
        await populateItemTypes();
      }
    });

    async function populateItemTypes() {
      const sel = document.getElementById('itemTypeSelect');
      sel.innerHTML = '';

      const sidebarItemTypeId = ctx?.itemType?.id || ctx?.itemTypeId;
      if (sidebarItemTypeId) {
        const opt = document.createElement('option');
        opt.value = sidebarItemTypeId;
        opt.textContent = `Current model (ID: ${sidebarItemTypeId})`;
        sel.appendChild(opt);
        sel.value = sidebarItemTypeId;
        log('Detected current model from sidebar context.');
        return;
      }

      try {
        const allItemTypes = await ctx.loaders.itemTypes.all();
        allItemTypes.forEach(t => {
          const opt = document.createElement('option');
          opt.value = t.id;
          opt.textContent = `${t.apiKey} (ID: ${t.id})`;
          sel.appendChild(opt);
        });
        log('Listed available models.');
      } catch {
        log('Could not list models automatically.');
      }
    }

    document.getElementById('previewBtn').addEventListener('click', async () => {
      const file = document.getElementById('fileInput').files?.[0];
      if (!file) return log('No file selected.');
      log(`Reading: ${file.name}`);

      try {
        parsedRows = await parseExcel(file);
        log(`Parsed ${parsedRows.length} rows. Preview:\n` + JSON.stringify(parsedRows.slice(0, 10), null, 2));
        document.getElementById('importBtn').disabled = parsedRows.length === 0;
      } catch (e) {
        log('Parse error: ' + (e?.message || e));
      }
    });

    document.getElementById('importBtn').addEventListener('click', async () => {
      if (!parsedRows.length) return log('Nothing to import. Click Preview first.');
      const itemTypeId = document.getElementById('itemTypeSelect').value || ctx?.itemType?.id;
      if (!itemTypeId) return log('Pick a target model first.');

      log(`Starting import into model ID ${itemTypeId}…`);
      let ok = 0, fail = 0;

      for (const row of parsedRows) {
        try {
          await createDatoItem(itemTypeId, row);
          ok++;
        } catch (err) {
          fail++;
          log('Error: ' + (err?.message || err));
        }
      }

      log(`Import finished. Success: ${ok}, Failed: ${fail}`);
    });

    function parseExcel(file) {
      return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onload = (e) => {
          const wb = XLSX.read(e.target.result, { type: 'binary' });
          const ws = wb.Sheets[wb.SheetNames[0]];
          const rows = XLSX.utils.sheet_to_json(ws, { defval: null });
          resolve(rows);
        };
        reader.onerror = reject;
        reader.readAsBinaryString(file);
      });
    }

    // MAP YOUR FIELDS HERE
    async function createDatoItem(itemTypeId, row) {
      const payload = {
        itemType: itemTypeId,
        title: row['Title'] ?? row['Name'],
        slug: (row['Slug'] ?? row['Title'] ?? '')
          .toString()
          .trim()
          .toLowerCase()
          .replace(/[^a-z0-9]+/g, '-')
          .replace(/(^-|-$)/g, '')
      };
      Object.keys(payload).forEach(k => payload[k] === undefined && delete payload[k]);
      return ctx.loaders.items.create(payload);
    }
  </script>
</body>
</html>
