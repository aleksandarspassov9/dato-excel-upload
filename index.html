<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <title>DatoCMS Excel Importer</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root { --border:#e5e7eb; --bg:#fafafa; --muted:#6b7280; }
    * { box-sizing: border-box; }
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; margin: 0; padding: 16px; }
    h3 { margin: 0 0 12px; }
    .card { border:1px solid var(--border); background:#fff; border-radius:12px; padding:16px; }
    .row { display:flex; gap:8px; align-items:center; flex-wrap:wrap; }
    input[type="file"] { padding:8px; border:1px dashed var(--border); border-radius:8px; background:var(--bg); }
    button { padding:8px 14px; border:1px solid var(--border); background:#111827; color:#fff; border-radius:8px; cursor:pointer; }
    button:disabled { opacity:.6; cursor:not-allowed; }
    label { color:var(--muted); font-size:12px; }
    select, input[type="text"] { padding:8px; border:1px solid var(--border); border-radius:8px; }
    #log { background:#fff; border:1px solid var(--border); border-radius:8px; padding:10px; height:220px; overflow:auto; white-space:pre-wrap; }
    .muted { color: var(--muted); font-size:12px; }
    .grid { display:grid; gap:12px; grid-template-columns: 1fr; }
  </style>
</head>
<body>
  <div class="grid">
    <div class="card">
      <h3>Excel → DatoCMS Import</h3>
      <div class="row" style="margin-top:8px;">
        <input id="fileInput" type="file" accept=".xlsx,.xls,.csv" />
        <button id="previewBtn">Preview</button>
        <button id="importBtn" disabled>Import</button>
      </div>

      <div class="row" style="margin-top:12px;">
        <label>Target model (auto when used as Sidebar on a model):</label>
        <select id="itemTypeSelect"></select>
      </div>

      <div class="row" style="margin-top:12px;">
        <label>Row limit (preview only):</label>
        <input id="previewLimit" type="text" value="10" style="width:80px" />
        <label>Batch size:</label>
        <input id="batchSize" type="text" value="25" style="width:80px" />
      </div>

      <div style="margin-top:12px;">
        <label class="muted">Edit field mapping in code section marked “MAP FIELDS HERE”</label>
      </div>
    </div>

    <div class="card">
      <h3>Log</h3>
      <pre id="log"></pre>
    </div>
  </div>

  <!-- XLSX browser build -->
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

  <!-- DatoCMS Plugin SDK UMD build -->
  <script src="https://unpkg.com/datocms-plugin-sdk/dist/datocms-plugin-sdk.js"></script>

  <script>
    const { connect, autoResizer } = window.DatoCmsPlugin;
    let ctx;
    let parsedRows = [];

    const el = (id) => document.getElementById(id);
    const log = (msg) => { el('log').textContent += msg + '\n'; el('log').scrollTop = el('log').scrollHeight; };
    const sleep = (ms) => new Promise(r => setTimeout(r, ms));

    connect({
      manualFieldExtensions() {
        return [];
      },
      manualSidebarExtensions() {
        return [{ id: 'excel-importer', label: 'Excel Importer', icon: 'file-spreadsheet' }];
      },
      async onBoot(pluginCtx) {
        ctx = pluginCtx;
        autoResizer.startAutoResizer();
        log('Connected to DatoCMS.');
        await populateItemTypes();
      }
    });

    async function populateItemTypes() {
      const sel = el('itemTypeSelect');
      sel.innerHTML = '';

      const sidebarItemTypeId = ctx?.itemType?.id || ctx?.itemTypeId;
      if (sidebarItemTypeId) {
        const opt = document.createElement('option');
        opt.value = sidebarItemTypeId;
        opt.textContent = `Current model (ID: ${sidebarItemTypeId})`;
        sel.appendChild(opt);
        sel.value = sidebarItemTypeId;
        log('Detected current model from sidebar context.');
        return;
      }

      try {
        const allItemTypes = await ctx.loaders.itemTypes.all();
        const collectionTypes = allItemTypes.filter(t => t.modularBlock === false);
        if (!collectionTypes.length) {
          log('No item types available.');
          return;
        }
        const placeholder = document.createElement('option');
        placeholder.value = '';
        placeholder.textContent = 'Select a model…';
        sel.appendChild(placeholder);

        for (const t of collectionTypes) {
          const opt = document.createElement('option');
          opt.value = t.id;
          opt.textContent = `${t.apiKey} (ID: ${t.id})`;
          sel.appendChild(opt);
        }
        log('Listed available models.');
      } catch {
        log('Could not list item types automatically.');
      }
    }

    el('previewBtn').addEventListener('click', async () => {
      const file = el('fileInput').files?.[0];
      if (!file) return log('No file selected.');
      log(`Reading: ${file.name}`);

      try {
        parsedRows = await parseExcel(file);
        const limit = parseInt(el('previewLimit').value || '10', 10);
        const preview = parsedRows.slice(0, limit);
        log(`Parsed ${parsedRows.length} rows. Preview (first ${limit}):\n` + JSON.stringify(preview, null, 2));
        el('importBtn').disabled = parsedRows.length === 0;
      } catch (e) {
        log('Parse error: ' + (e?.message || e));
      }
    });

    el('importBtn').addEventListener('click', async () => {
      if (!parsedRows.length) return log('Nothing to import. Click Preview first.');
      const itemTypeId = (el('itemTypeSelect').value || ctx?.itemType?.id || ctx?.itemTypeId || '').trim();
      if (!itemTypeId) return log('Pick a target model first.');

      const batchSize = Math.max(1, parseInt(el('batchSize').value || '25', 10));
      el('importBtn').disabled = true;

      log(`Starting import into model ID ${itemTypeId} in batches of ${batchSize}…`);
      let ok = 0, fail = 0;

      for (let i = 0; i < parsedRows.length; i += batchSize) {
        const batch = parsedRows.slice(i, i + batchSize);
        const results = await Promise.allSettled(batch.map(row => createDatoItem(itemTypeId, row)));

        for (const r of results) {
          if (r.status === 'fulfilled') ok++;
          else { fail++; log('Error: ' + (r.reason?.message || r.reason || 'Unknown')); }
        }

        log(`Imported ${ok} / ${parsedRows.length} so far…`);
        await sleep(250);
      }

      log(`Import finished. Success: ${ok}, Failed: ${fail}`);
      el('importBtn').disabled = false;
    });

    function parseExcel(file) {
      return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onload = (e) => {
          const wb = XLSX.read(e.target.result, { type: 'binary' });
          const ws = wb.Sheets[wb.SheetNames[0]];
          const rows = XLSX.utils.sheet_to_json(ws, { defval: null });
          resolve(rows);
        };
        reader.onerror = reject;
        reader.readAsBinaryString(file);
      });
    }

    // MAP YOUR FIELDS HERE
    async function createDatoItem(itemTypeId, row) {
      const payload = {
        itemType: itemTypeId,
        // Example mapping:
        title: row['Title'] ?? row['Name'],
        slug: (row['Slug'] ?? row['Title'] ?? '').toString().trim().toLowerCase().replace(/[^a-z0-9]+/g,'-').replace(/(^-|-$)/g,'')
        // Add other field mappings here...
      };
      Object.keys(payload).forEach(k => payload[k] === undefined && delete payload[k]);
      return ctx.loaders.items.create(payload);
    }
  </script>
</body>
</html>
