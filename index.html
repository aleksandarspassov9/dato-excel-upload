<!-- index.html -->
<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Excel Importer Plugin</title>
  </head>
  <body>
    <div id="app">Loading pluginâ€¦</div>
    <script type="module">
      import { connect } from 'https://cdn.skypack.dev/datocms-plugin-sdk';
      import * as XLSX from 'https://cdn.skypack.dev/xlsx';

      connect({
        onBoot(ctx) {
          document.getElementById('app').innerHTML = `
            <h3>Upload Excel File</h3>
            <input type="file" id="fileInput" accept=".xlsx, .xls">
            <button id="importBtn">Import</button>
            <pre id="log"></pre>
          `;

          const log = (msg) =>
            (document.getElementById('log').textContent += msg + '\n');

          document
            .getElementById('importBtn')
            .addEventListener('click', async () => {
              const file = document.getElementById('fileInput').files[0];
              if (!file) return log('No file selected');

              const data = await parseExcel(file);
              log(`Parsed ${data.length} rows from Excel.`);

              const itemTypeId = 'YOUR_ITEM_TYPE_ID';
              for (const row of data) {
                try {
                  await ctx.loaders.items.create({
                    itemType: itemTypeId,
                    field1: row['Column A'],
                    field2: row['Column B'],
                  });
                  log(`Imported: ${row['Column A']}`);
                } catch (e) {
                  log(`Error: ${e.message}`);
                }
              }
            });

          function parseExcel(file) {
            return new Promise((resolve, reject) => {
              const reader = new FileReader();
              reader.onload = (e) => {
                const wb = XLSX.read(e.target.result, { type: 'binary' });
                const ws = wb.Sheets[wb.SheetNames[0]];
                resolve(XLSX.utils.sheet_to_json(ws));
              };
              reader.onerror = reject;
              reader.readAsBinaryString(file);
            });
          }
        },
      });
    </script>
  </body>
</html>
